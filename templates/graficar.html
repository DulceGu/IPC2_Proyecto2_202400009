
<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta charset="UTF-8">
    <title>Generar Gráfico TDA - GuateRiegos 2.0</title>
</head>
<body>
    <div class="header">
        <h1> Generar Gráfico de TDAs</h1>
        <p>Visualiza el estado del sistema en un tiempo específico</p>
    </div>

    <div class="container">
        <div class="card">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert {{ 'success' if category == 'success' else 'error' }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" class="graph-form">
                <div class="form-group">
                    <label for="invernadero">Invernadero:</label>
                    <select name="invernadero" id="invernadero" required class="form-select">
                        <option value="">-- Seleccione un invernadero --</option>
                        {% for nombre in invernaderos %}
                            <option value="{{ nombre }}" {% if nombre == invernadero_sel %}selected{% endif %}>
                                {{ nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="plan">Plan de Riego:</label>
                    <select name="plan" id="plan" required class="form-select">
                        <option value="">-- Seleccione un plan --</option>
                        {% for plan in planes %}
                            <option value="{{ plan.nombre }}" {% if plan.nombre == plan_sel %}selected{% endif %}>
                                {{ plan.nombre }} ({{ plan.tiempo_optimo }}s)
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="tiempo">Tiempo t (segundos):</label>
                    <input type="number" name="tiempo" id="tiempo" 
                           min="1" max="{{ tiempo_max }}" value="{{ tiempo_sel }}"
                           placeholder="Ingrese el tiempo en segundos" required
                           class="form-input">
                    <small>Rango: 1 - {{ tiempo_max }} segundos</small>
                </div>

                <button type="submit" class="btn btn-block btn-primary">
                     Generar Gráfico TDA
                </button>
            </form>
        </div>

        {% if imagen_url %}
        <div class="card">
            <h3> Gráfico Generado - Tiempo t={{ tiempo_sel }}</h3>
            <div class="graph-container">
                <img src="{{ imagen_url }}" alt="Gráfico TDA" style="max-width: 100%; border: 1px solid #ccc;">
            </div>
            
            <div class="navigation" style="margin-top: 20px;">
                <a href="{{ url_for('graficar') }}?invernadero={{ invernadero_sel }}&plan={{ plan_sel }}&tiempo={{ [tiempo_sel - 1, 1]|max }}" 
                   class="btn btn-secondary">← Tiempo anterior</a>
                <a href="{{ url_for('graficar') }}?invernadero={{ invernadero_sel }}&plan={{ plan_sel }}&tiempo={{ [tiempo_sel + 1, tiempo_max]|min }}" 
                   class="btn btn-secondary">Siguiente tiempo →</a>
            </div>
        </div>
        {% endif %}

        {% if invernadero_sel %}
        <div class="card">
            <h3> Información de Depuración</h3>
            <p><strong>Invernadero seleccionado:</strong> {{ invernadero_sel }}</p>
            <p><strong>Planes encontrados:</strong> {{ planes|length }}</p>
            <ul>
                {% for plan in planes %}
                    <li>{{ plan.nombre }} - Tiempo óptimo: {{ plan.tiempo_optimo }}s - Pasos: {{ plan.orden_riego.tamanio }}</li>
                {% endfor %}
            </ul>
        </div>
        {% endif %}

        <div class="navigation">
            <a href="{{ url_for('index') }}" class="btn btn-secondary">← Volver al Inicio</a>
        </div>
    </div>

    <script>
        // Actualizar el tiempo máximo cuando se selecciona un plan
        document.getElementById('plan').addEventListener('change', function() {
            const planOption = this.options[this.selectedIndex];
            const tiempoMax = planOption.text.match(/\((\d+)s\)/);
            if (tiempoMax) {
                document.getElementById('tiempo').max = tiempoMax[1];
                document.getElementById('tiempo').value = 1;
            }
        });
    </script>
</body>
</html>